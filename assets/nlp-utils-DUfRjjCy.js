function t(t){const e=function(t){return t?t.replace(/[إأآ]/g,"ا").replace(/ى/g,"ي").replace(/ة/g,"ه").replace(/[\u064B-\u065F]/g,"").replace(/ـ/g,"").replace(/\s+/g," ").trim():""}(t);return e.split(/\s+/).filter(t=>t.length>0)}function e(t){return null==t||"string"!=typeof t?[]:t.split(/[.!؟?।\n]+/).map(t=>t.trim()).filter(t=>t.length>10)}function n(t){return null==t||"string"!=typeof t?[]:t.split(/\n\n+/).map(t=>t.trim()).filter(t=>t.length>20)}function s(e){return t(e).length}function r(s){const r=t(s),a=e(s),i=n(s),o=new Set(r);return{words:r.length,sentences:a.length,paragraphs:i.length,uniqueWords:o.size,avgWordsPerSentence:r.length/Math.max(a.length,1),avgWordsPerParagraph:r.length/Math.max(i.length,1),vocabularyRichness:o.size/Math.max(r.length,1)}}function a(t){const e=(t.match(/[\u0600-\u06FF]/g)||[]).length,n=t.replace(/\s/g,"").length,s=e/Math.max(n,1);return s>.7?"ar":s>.3?"mixed":"other"}const i={chapter:[/(?:الفصل|الباب|القسم)\s+(?:الأول|الثاني|الثالث|الرابع|الخامس|السادس|السابع|الثامن|التاسع|العاشر|الحادي عشر|الثاني عشر)/gi,/(?:الفصل|الباب|القسم)\s+(\d+)/gi,/Chapter\s+(\d+|[IVXLC]+)/gi,/الجزء\s+(?:الأول|الثاني|الثالث|\d+)/gi],page:[/(?:ص|صفحة|صفحه|page)\s*\.?\s*(\d+)/gi,/\[(\d+)\]/g,/^(\d+)$/gm],toc:/(?:فهرس|محتويات|المحتويات|جدول المحتويات|table of contents)/gi},o={"الأول":1,"الثاني":2,"الثالث":3,"الرابع":4,"الخامس":5,"السادس":6,"السابع":7,"الثامن":8,"التاسع":9,"العاشر":10,"الحادي عشر":11,"الثاني عشر":12,"الثالث عشر":13};function l(t){if(null==t||"string"!=typeof t)return[];const e=[];return i.chapter.forEach(n=>{let s;const r=new RegExp(n.source,n.flags);for(;null!==(s=r.exec(t));){const n=s[0],r=s[1]||n;e.push({type:"chapter",number:p(r),position:s.index,text:n,line:t.substring(0,s.index).split("\n").length})}}),e.sort((t,e)=>t.position-e.position)}function c(t){if(null==t||"string"!=typeof t)return[];const e=[];return i.page.forEach(n=>{let s;const r=new RegExp(n.source,n.flags);for(;null!==(s=r.exec(t));){const n=parseInt(s[1]||s[0]);n&&n<1e4&&e.push({type:"page",number:n,position:s.index,text:s[0],line:t.substring(0,s.index).split("\n").length})}}),e.sort((t,e)=>t.number-e.number)}function h(t){if(null==t||"string"!=typeof t)return null;const e=t.match(i.toc);if(!e)return null;const n=e.index,s=t.substring(n).split("\n"),r=[];for(let a=1;a<Math.min(s.length,50);a++){const t=s[a].trim();if(t.length>100||a>20&&!/\d+/.test(t))break;const e=t.match(/^(.+?)\s*[.…]+\s*(\d+)$/);e&&r.push({title:e[1].trim(),page:parseInt(e[2]),level:d(t)})}return r.length>0?r:null}function g(t){if(null==t||"string"!=typeof t)return{headers:[],paragraphs:[],lists:[],quotes:[],codeBlocks:[]};const e=t.split("\n"),n={headers:[],paragraphs:[],lists:[],quotes:[],codeBlocks:[]};let s=!1;return e.forEach((t,e)=>{const r=t.trim();if(r.startsWith("```"))s=!s;else if(s)n.codeBlocks.push({line:e,text:t});else{if(/^#+\s/.test(r)){const t=r.match(/^#+/),s=t?t[0].length:0;n.headers.push({line:e,text:r.replace(/^#+\s*/,""),level:s})}else r.length>5&&r.length<80&&/^[A-Z\u0600-\u06FF]/.test(r)&&!/[.،؟!]$/.test(r)&&n.headers.push({line:e,text:r,level:0,alternative:!0});(/^[-*•●]\s/.test(r)||/^\d+\.\s/.test(r))&&n.lists.push({line:e,text:r}),(/^>\s/.test(r)||/^["«"]/.test(r))&&n.quotes.push({line:e,text:r}),r.length>50&&n.paragraphs.push({line:e,text:r,words:r.split(/\s+/).length})}}),n}function u(t){return{chapters:l(t),pages:c(t),toc:h(t),structure:g(t),hasChapters:l(t).length>0,hasPageNumbers:c(t).length>0,hasTOC:null!==h(t)}}function p(t){const e=parseInt(t);return isNaN(e)?o[t]||0:e}function d(t){if(null==t)return 0;const e=t.match(/^\s*/);return Math.floor((e?e[0]:"").length/2)}const f={verbs:/كان|أصبح|ذهب|جاء|رأى|سمع|شعر|قرر|فكر/g,timeMarkers:/اليوم|غداً|أمس|حين|عندما|بعد|قبل|منذ/g,pronouns:/هو|هي|هم|هن|أنا|نحن/g},m={quotes:/["«»""]/g,verbs:/قال|قالت|أجاب|ردّ|سأل|صرخ|همس/g,punctuation:/[!؟?]/g},x={adjectives:/جميل|كبير|صغير|طويل|قصير|واسع|ضيق/g,colors:/أحمر|أزرق|أخضر|أصفر|أبيض|أسود/g,sensory:/رائحة|صوت|ملمس|طعم|منظر/g},w={keywords:/function|class|return|if|for|while|const|let|var/g,brackets:/[{}();]/g,operators:/[+\-*/%=<>!&|]/g},b={citations:/\[\d+\]|\(\d{4}\)/g,phrases:/نستنتج|نخلص|الدراسة|البحث|النتائج|الخلاصة|التحليل/g,formality:/بناءً على|وفقاً|حيث أن|من الواضح/g};function v(t,e){let n=0;return Object.values(e).forEach(e=>{const s=(t.match(e)||[]).length;n+=s}),n}function I(e){const n=t(e).length;if(0===n)return{type:"unknown",confidence:0,scores:{}};const s={narrative:v(e,f)/n,dialogue:v(e,m)/n,description:v(e,x)/n,code:v(e,w)/n,academic:v(e,b)/n},r=Object.entries(s).sort((t,e)=>e[1]-t[1]),[a,i]=r[0];return{type:a,confidence:Math.min(10*i,1),scores:s,features:M(e)}}function M(n){const s=t(n),r=e(n),a=new Set(s);return{dialogueQuotes:(n.match(/["«»""]/g)||[]).length,dialogueVerbs:(n.match(/قال|قالت|أجاب|ردّ|سأل/g)||[]).length,narrativeVerbs:(n.match(/كان|أصبح|ذهب|جاء|رأى/g)||[]).length,timeMarkers:(n.match(/اليوم|غداً|أمس|حين|عندما/g)||[]).length,codePatterns:(n.match(/function|class|return|if|for/g)||[]).length,codeBrackets:(n.match(/[{}();]/g)||[]).length,citations:(n.match(/\[\d+\]|\(\d{4}\)/g)||[]).length,academicPhrases:(n.match(/نستنتج|نخلص|الدراسة|البحث/g)||[]).length,avgSentenceLength:s.length/Math.max(r.length,1),vocabularyRichness:a.size/Math.max(s.length,1)}}function y(t){if(null==t||"string"!=typeof t)return[];return t.split(/\n\n+/).filter(t=>t&&t.trim().length>50).map((t,e)=>({index:e,text:t.substring(0,100)+"...",classification:I(t)}))}function C(t,e){const n=I(t);return n.type!==e&&n.confidence>.6?{isIrrelevant:!0,reason:`Content type mismatch: expected ${e}, got ${n.type}`,confidence:n.confidence}:"narrative"===e&&n.scores.code>.3?{isIrrelevant:!0,reason:"Code detected in narrative text",confidence:n.scores.code}:{isIrrelevant:!1}}function E(t){let e=0;for(let n=0;n<t.length;n++){e=(e<<5)-e+t.charCodeAt(n),e&=e}return e}function S(e,n=.8){const s=e.split(/\n\n+/),r=new Map,a=[];return s.forEach(e=>{const s=t(e);if(s.length<10)return void a.push(e);const i=s.slice(0,15).join(" "),o=E(i);let l=!1;for(const t of r.values()){if(k(i,t)>n){l=!0;break}}l||(a.push(e),r.set(o,i))}),a.join("\n\n")}function k(e,n){const s=new Set(t(e)),r=new Set(t(n)),a=new Set([...s].filter(t=>r.has(t))),i=new Set([...s,...r]);return a.size/Math.max(i.size,1)}function R(e){const n=function(e,n=5){const s=t(e),r=new Map,a=[];for(let t=0;t<=s.length-n;t++){const e=s.slice(t,t+n).join(" "),i=E(e);r.has(i)?a.push({position:t,firstPosition:r.get(i),text:e,hash:i}):r.set(i,t)}const i=s.length-n+1,o=r.size;return{duplicates:a,repetitionRate:a.length/Math.max(i,1)*100,uniqueShingles:o,totalShingles:i}}(e),s=function(e){const n=e.split(/\n\n+/).filter(t=>t.trim().length>20),s=new Map,r=[];return n.forEach((e,n)=>{const a=E(t(e).slice(0,20).join(" "));s.has(a)?r.push({index:n,duplicateOf:s.get(a),text:e.substring(0,100)+"..."}):s.set(a,n)}),r}(e),r=function(e,n=2){const s=e.split(/[.!؟?।]+/).filter(t=>t.trim().length>10),r=new Map;s.forEach(e=>{const n=E(t(e).join(" ")),s=r.get(n)||{count:0,text:e};s.count++,r.set(n,s)});const a=[];return r.forEach((t,e)=>{t.count>=n&&a.push({text:t.text.substring(0,100),count:t.count,hash:e})}),a.sort((t,e)=>e.count-t.count)}(e);return{overall:{repetitionRate:n.repetitionRate,hasIssues:n.repetitionRate>15||s.length>0},shingles:{total:n.totalShingles,unique:n.uniqueShingles,duplicates:n.duplicates.length,rate:n.repetitionRate},paragraphs:{total:e.split(/\n\n+/).length,duplicates:s.length,items:s.slice(0,5)},sentences:{repeated:r.length,items:r.slice(0,5)},recommendation:n.repetitionRate>20?"high_repetition":n.repetitionRate>10?"moderate_repetition":"acceptable"}}function j(t,e={}){const{minChapters:r=2,maxChapters:a=13,targetWordsPerChapter:i=6e3,preserveExisting:o=!0}=e,c=l(t);if(o&&c.length>=r&&c.length<=a)return{method:"existing",chapters:c.map((t,e)=>({number:e+1,title:t.title,startLine:t.line,startPos:t.position,existing:!0}))};const h=s(t),g=Math.round(h/i),u=Math.max(r,Math.min(a,g)),p=n(t),d=Math.floor(h/u),f=[];let m={paragraphs:[],words:0,startIdx:0};p.forEach((t,e)=>{const n=s(t),r=m.words>=.8*d&&f.length<u-1&&(function(t){const e=t.trim(),n=s(e);if(n<20)return!0;const r=[/^في اليوم التالي/i,/^بعد ذلك/i,/^وفي صباح/i,/^مرت أيام/i,/^مرت الأيام/i,/^وبعد/i,/^ثم/i,/^الفصل/i,/^الباب/i];for(const s of r)if(s.test(e))return!0;const a=[/وانتهى/i,/والآن/i,/وهكذا/i,/في النهاية/i,/أخيراً/i];for(const s of a)if(s.test(e))return!0;return!1}(t)||m.words+n>1.3*d);r&&m.paragraphs.length>0?(f.push({number:f.length+1,title:P(f.length+1),startIdx:m.startIdx,endIdx:e-1,paragraphs:m.paragraphs.length,words:m.words,text:m.paragraphs.join("\n\n")}),m={paragraphs:[t],words:n,startIdx:e}):(m.paragraphs.push(t),m.words+=n)}),m.paragraphs.length>0&&f.push({number:f.length+1,title:P(f.length+1),startIdx:m.startIdx,endIdx:p.length-1,paragraphs:m.paragraphs.length,words:m.words,text:m.paragraphs.join("\n\n")});const x=function(t,e){const n=[];let s=null;for(let r=0;r<t.length;r++){const a=t[r];a.words<.4*e&&r<t.length-1?s?(s.words+=a.words,s.paragraphs+=a.paragraphs,s.endIdx=a.endIdx,s.text+="\n\n"+a.text):s={...a}:(s&&(a.words+=s.words,a.paragraphs+=s.paragraphs,a.startIdx=s.startIdx,a.text=s.text+"\n\n"+a.text,s=null),n.push({...a,number:n.length+1,title:P(n.length+1)}))}if(s&&n.length>0){const t=n[n.length-1];t.words+=s.words,t.paragraphs+=s.paragraphs,t.endIdx=s.endIdx,t.text+="\n\n"+s.text}return n}(f,d);return{method:"smart",totalWords:h,targetChapters:u,actualChapters:x.length,avgWordsPerChapter:Math.round(h/x.length),chapters:x}}function P(t){return t<=13?`الفصل ${["","الأول","الثاني","الثالث","الرابع","الخامس","السادس","السابع","الثامن","التاسع","العاشر","الحادي عشر","الثاني عشر","الثالث عشر"][t]}`:`الفصل ${t}`}export{R as a,C as b,y as c,a as d,I as e,c as f,r as g,l as h,n as p,u as q,S as r,j as s,s as w};
