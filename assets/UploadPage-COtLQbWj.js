import{j as e}from"./query-vendor-Dt0le05-.js";import{a as t}from"./react-vendor-Bs_e_mwx.js";import{b as s}from"./index-3Yd-DfCj.js";import{a as n}from"./geminiClient--LmOtRoR.js";import{p as a,w as r,d as o,g as i,q as c,a as l,c as d,b as u,e as h,f as p,h as g,r as m,s as x}from"./nlp-utils-DUfRjjCy.js";import{U as y,q as f,C as w,X as b,F as v,A as j}from"./ui-vendor-CeVg9BGE.js";import"./chart-vendor-ce8NDi9W.js";const _=(e,t)=>t.some(t=>e instanceof t);let D,C;const N=new WeakMap,k=new WeakMap,S=new WeakMap;let B={get(e,t,s){if(e instanceof IDBTransaction){if("done"===t)return N.get(e);if("store"===t)return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return L(e[t])},set:(e,t,s)=>(e[t]=s,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function M(e){B=e(B)}function E(e){return(C||(C=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(I(this),t),L(this.request)}:function(...t){return L(e.apply(I(this),t))}}function F(e){return"function"==typeof e?E(e):(e instanceof IDBTransaction&&function(e){if(N.has(e))return;const t=new Promise((t,s)=>{const n=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",r),e.removeEventListener("abort",r)},a=()=>{t(),n()},r=()=>{s(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",a),e.addEventListener("error",r),e.addEventListener("abort",r)});N.set(e,t)}(e),_(e,D||(D=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,B):e)}function L(e){if(e instanceof IDBRequest)return function(e){const t=new Promise((t,s)=>{const n=()=>{e.removeEventListener("success",a),e.removeEventListener("error",r)},a=()=>{t(L(e.result)),n()},r=()=>{s(e.error),n()};e.addEventListener("success",a),e.addEventListener("error",r)});return S.set(t,e),t}(e);if(k.has(e))return k.get(e);const t=F(e);return t!==e&&(k.set(e,t),S.set(t,e)),t}const I=e=>S.get(e);const P=["get","getKey","getAll","getAllKeys","count"],T=["put","add","delete","clear"],z=new Map;function $(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(z.get(t))return z.get(t);const s=t.replace(/FromIndex$/,""),n=t!==s,a=T.includes(s);if(!(s in(n?IDBIndex:IDBObjectStore).prototype)||!a&&!P.includes(s))return;const r=async function(e,...t){const r=this.transaction(e,a?"readwrite":"readonly");let o=r.store;return n&&(o=o.index(t.shift())),(await Promise.all([o[s](...t),a&&r.done]))[0]};return z.set(t,r),r}M(e=>({...e,get:(t,s,n)=>$(t,s)||e.get(t,s,n),has:(t,s)=>!!$(t,s)||e.has(t,s)}));const A=["continue","continuePrimaryKey","advance"],R={},O=new WeakMap,W=new WeakMap,K={get(e,t){if(!A.includes(t))return e[t];let s=R[t];return s||(s=R[t]=function(...e){O.set(this,W.get(this)[t](...e))}),s}};async function*q(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;const s=new Proxy(t,K);for(W.set(s,t),S.set(s,I(t));t;)yield s,t=await(O.get(s)||t.continue()),O.delete(s)}function V(e,t){return t===Symbol.asyncIterator&&_(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&_(e,[IDBIndex,IDBObjectStore])}M(e=>({...e,get:(t,s,n)=>V(t,s)?q:e.get(t,s,n),has:(t,s)=>V(t,s)||e.has(t,s)}));const J=new class{constructor(){this.memory=new Map,this.db=null,this.maxMemorySize=100,this.initDB()}async initDB(){try{this.db=await function(e,t,{blocked:s,upgrade:n,blocking:a,terminated:r}={}){const o=indexedDB.open(e,t),i=L(o);return n&&o.addEventListener("upgradeneeded",e=>{n(L(o.result),e.oldVersion,e.newVersion,L(o.transaction),e)}),s&&o.addEventListener("blocked",e=>s(e.oldVersion,e.newVersion,e)),i.then(e=>{r&&e.addEventListener("close",()=>r()),a&&e.addEventListener("versionchange",e=>a(e.oldVersion,e.newVersion,e))}).catch(()=>{}),i}("seyadi-cache",1,{upgrade(e){e.objectStoreNames.contains("analyses")||e.createObjectStore("analyses"),e.objectStoreNames.contains("llm-results")||e.createObjectStore("llm-results"),e.objectStoreNames.contains("manuscripts")||e.createObjectStore("manuscripts")}})}catch(e){}}createKey(e,t){const s=JSON.stringify({operation:e,params:t});return this.simpleHash(s)}simpleHash(e){let t=0;for(let s=0;s<e.length;s++){t=(t<<5)-t+e.charCodeAt(s),t&=t}return t.toString(36)}getFromMemory(e){const t=this.memory.get(e);return t?t.expires&&Date.now()>t.expires?(this.memory.delete(e),null):t.value:null}setInMemory(e,t,s=3e5){this.memory.set(e,{value:t,expires:Date.now()+s,timestamp:Date.now()}),this.memory.size>this.maxMemorySize&&this.cleanOldestMemoryEntries(),setTimeout(()=>{this.memory.delete(e)},s)}cleanOldestMemoryEntries(){const e=Array.from(this.memory.entries());e.sort((e,t)=>e[1].timestamp-t[1].timestamp);const t=Math.floor(.2*e.length);for(let s=0;s<t;s++)this.memory.delete(e[s][0])}async getFromDB(e,t){this.db||await this.initDB();try{const s=await this.db.get(e,t);return s?s.expires&&Date.now()>s.expires?(await this.db.delete(e,t),null):s.value:null}catch(s){return null}}async setInDB(e,t,s,n=null){this.db||await this.initDB();try{await this.db.put(e,{value:s,expires:n?Date.now()+n:null,timestamp:Date.now()},t)}catch(a){}}async deleteFromDB(e,t){this.db||await this.initDB();try{await this.db.delete(e,t)}catch(s){}}async clearStore(e){this.db||await this.initDB();try{await this.db.clear(e)}catch(t){}}async get(e,t,s={}){const n=this.createKey(e,t),a=s.store||"analyses";let r=this.getFromMemory(n);return null!==r?{source:"memory",data:r}:(r=await this.getFromDB(a,n),null!==r?(this.setInMemory(n,r,s.memoryTTL),{source:"db",data:r}):null)}async set(e,t,s,n={}){const a=this.createKey(e,t),r=n.store||"analyses";this.setInMemory(a,s,n.memoryTTL||3e5),!1!==n.persist&&await this.setInDB(r,a,s,n.dbTTL)}async delete(e,t,s={}){const n=this.createKey(e,t),a=s.store||"analyses";this.memory.delete(n),await this.deleteFromDB(a,n)}getStats(){return{memory:{size:this.memory.size,maxSize:this.maxMemorySize,usage:this.memory.size/this.maxMemorySize*100}}}clearMemory(){this.memory.clear()}async clearAll(){this.clearMemory(),this.db&&(await this.clearStore("analyses"),await this.clearStore("llm-results"),await this.clearStore("manuscripts"))}};class X{constructor(e=1e4){this.maxChunkSize=e}chunkText(e){const t=a(e),s=[];let n=[],o=0;for(const a of t){const e=r(a);o+e>this.maxChunkSize&&n.length>0?(s.push({text:n.join("\n\n"),words:o,paragraphs:n.length,index:s.length}),n=[a],o=e):(n.push(a),o+=e)}return n.length>0&&s.push({text:n.join("\n\n"),words:o,paragraphs:n.length,index:s.length}),s}async processParallel(e,t,s={}){const{concurrency:n=3,onProgress:a=()=>{},onChunkComplete:r=()=>{},onChunkError:o=()=>{}}=s,i=[];let c=0,l=0;for(let d=0;d<e.length;d+=n){const s=e.slice(d,d+n),u=await Promise.allSettled(s.map(async(s,n)=>{const i=d+n;try{const n=await t(s,i);return c++,a({completed:c,total:e.length,failed:l,percentage:c/e.length*100}),r(n,i),n}catch(u){throw l++,o(u,i),u}}));i.push(...u.map(e=>"fulfilled"===e.status?e.value:null))}return{results:i.filter(Boolean),summary:{total:e.length,completed:c,failed:l,successRate:c/e.length*100}}}async*streamProcess(e,t){const s=e.stream().getReader(),n=new TextDecoder;let a="",o=0;for(;;){const{done:e,value:r}=await s.read();if(e)break;a+=n.decode(r,{stream:!0});const i=a.split(/\s+/);if(i.length>=this.maxChunkSize){const e=i.slice(0,this.maxChunkSize).join(" ");a=i.slice(this.maxChunkSize).join(" ");const s=await t({text:e,index:o,words:this.maxChunkSize},o);yield s,o++}}if(a.trim()){const e=await t({text:a,index:o,words:r(a)},o);yield e}}mergeResults(e,t="analysis"){return"analysis"===t?this.mergeAnalysisResults(e):"text"===t?this.mergeTextResults(e):e}mergeAnalysisResults(e){const t={totalWords:0,totalSentences:0,totalParagraphs:0,issues:[],warnings:[],chapters:[],pages:[],classifications:[]};if(e.forEach((e,s)=>{e&&(t.totalWords+=e.words||0,t.totalSentences+=e.sentences||0,t.totalParagraphs+=e.paragraphs||0,e.issues&&t.issues.push(...e.issues.map(e=>({...e,chunk:s}))),e.warnings&&t.warnings.push(...e.warnings.map(e=>({...e,chunk:s}))),e.chapters&&t.chapters.push(...e.chapters),e.pages&&t.pages.push(...e.pages),e.classification&&t.classifications.push(e.classification))}),t.classifications.length>0){const e={};t.classifications.forEach(t=>{e[t.type]=(e[t.type]||0)+1});const s=Object.entries(e).sort((e,t)=>t[1]-e[1])[0];t.overallType=s[0],t.typeConfidence=s[1]/t.classifications.length}return t}mergeTextResults(e){return e.filter(Boolean).map(e=>e.text||e).join("\n\n")}}const H=/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/,U=/[\u0621-\u064A]/g,G=[/Ã˜Â£|Ã™\u0088|Ã˜Â§|Ã˜Â¨|Ã™Å |Ã˜Â©|Ã™\u0085|Ã˜Â¯|Ã˜Â±/g,/Ã¯Â»\u00BF|Ã¯Â»Â½|Ã¯Â»Â¾/g,/Ã¢â‚¬\u009C|Ã¢â‚¬\u009D|Ã¢â‚¬\u0093/g,/\uFFFD/g],Z=70,Q=2,Y=100,ee=.01;function te(e,t=null){if(!e||"string"!=typeof e)throw new Error("Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¯Ø®Ù„ ØºÙŠØ± ØµØ§Ù„Ø­");const s=function(e){const t=[];G.forEach((s,n)=>{const a=e.match(s);a&&a.length>0&&t.push({type:`pattern_${n}`,count:a.length,samples:a.slice(0,5)})});const s=[];for(let a=0;a<e.length;a++){const t=e[a],n=t.charCodeAt(0);/[\s\d.,;:!?()[\]{}\\-]/.test(t)||H.test(t)&&n>=65533&&s.push({char:t,code:n.toString(16),position:a})}s.length>0&&t.push({type:"invalid_unicode",count:s.length,samples:s.slice(0,5)});const n=e.length>0?t.reduce((e,t)=>e+t.count,0)/e.length:0;return{isCorrupted:n>ee,corruptionRate:(100*n).toFixed(3)+"%",corruptions:t,totalCorrupted:t.reduce((e,t)=>e+t.count,0)}}(e),n=function(e){if(e.length<Y)return{consistent:!0,warning:"Ø§Ù„Ù†Øµ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¯Ù‚ÙŠÙ‚"};const t=o(e),s=(e.match(U)||[]).length,n=e.replace(/[\s\d.,;:!?()[\]{}\\-]/g,"").length,a=n>0?s/n*100:0,r=/[a-zA-Z]{3,}/.test(e),i=[];a>10&&i.push("ar"),r&&i.push("en");const c=[];return"ar"===t&&a<Z&&c.push(`Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø© (${a.toFixed(1)}%) ÙÙŠ Ù†Øµ ÙŠÙÙØªØ±Ø¶ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¹Ø±Ø¨ÙŠØ§Ù‹`),i.length>Q&&c.push(`Ø®Ù„ÙŠØ· Ù…Ù† ${i.length} Ù„ØºØ§Øª: ${i.join(", ")}`),{consistent:0===c.length,detectedLanguage:t,arabicPercentage:a.toFixed(1)+"%",languageMix:i,issues:c}}(e);let a=null;t&&(a=function(e,t){const s=o(e),n=o(t),a=i(e),r=i(t),c=s!==n,l=Math.abs(a.arabicPercentage-r.arabicPercentage)>15;return{languageChanged:c,originalLanguage:s,processedLanguage:n,significantChange:l,originalArabicPct:a.arabicPercentage?.toFixed(1)+"%",processedArabicPct:r.arabicPercentage?.toFixed(1)+"%",valid:!c&&!l}}(t,e));const r=[],c=[];s.isCorrupted&&r.push(`Ø§Ù„Ù†Øµ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø­Ø±Ù Ù…Ø´ÙˆÙ‡Ø© (${s.corruptionRate})`),n.consistent||r.push(...n.issues),a&&!a.valid&&(a.languageChanged&&r.push(`ØªØºÙŠØ±Øª Ø§Ù„Ù„ØºØ© Ù…Ù† ${a.originalLanguage} Ø¥Ù„Ù‰ ${a.processedLanguage}`),a.significantChange&&c.push(`ØªØºÙŠØ± ÙƒØ¨ÙŠØ± ÙÙŠ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©: ${a.originalArabicPct} â†’ ${a.processedArabicPct}`));const l=0===r.length;return{passed:l,valid:l,issues:r,warnings:c,corruption:s,consistency:n,comparison:a,score:se(s,n,a)}}function se(e,t,s){let n=100;return e.isCorrupted&&(n-=Math.min(30,5*e.totalCorrupted)),t.consistent||(n-=10*t.issues.length),s&&!s.valid&&(s.languageChanged&&(n-=25),s.significantChange&&(n-=15)),Math.max(0,n)}function ne(e){const t={};return e.forEach(e=>{t[e.type]=(t[e.type]||0)+1}),Object.entries(t).sort((e,t)=>t[1]-e[1])[0]?.[0]||"unknown"}function ae(e,t,s,n){const a=[];s>15&&a.push("Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¹Ø§Ù„ÙŠØ© - ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙƒØ±Ø§Ø±"),n>10&&a.push("ØªÙ… Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ø°ÙŠ ØµÙ„Ø© - ØªÙ… Ø¥Ø²Ø§Ù„ØªÙ‡");return t/e*100<70&&a.push("ØªÙ… Ø­Ø°Ù Ø£ÙƒØ«Ø± Ù…Ù† 30% Ù…Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ - Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù†ØªÙŠØ¬Ø©"),t<3e4&&a.push("Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ (30k) - Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ¹ÙˆÙŠØ¶"),a.length>0?a:["Ø§Ù„Ù†Øµ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù†Ø´Ø±"]}function re(e,t,s){let n=0;return e>5&&n++,"existing"!==t&&n++,s>5e3&&s<15e3&&n++,n}const oe=()=>{const[a,b]=t.useState([]),[v,j]=t.useState(!1),[_,D]=t.useState(!1),[C,N]=t.useState(null),[k,S]=t.useState(null),B=t.useRef(null),{success:M,error:E}=s(),F=e=>{const t=e.name.substring(e.name.lastIndexOf(".")).toLowerCase();if(!["text/plain"].includes(e.type)&&![".txt"].includes(t))return E("Ø§Ù„Ø¢Ù† Ù†Ø¯Ø¹Ù… Ù…Ù„ÙØ§Øª TXT ÙÙ‚Ø·. Ø­ÙˆÙ‘Ù„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ TXT Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹."),!1;return!(e.size>52428800)||(E("Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 50 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª"),!1)},L=async e=>{const t=Array.from(e).filter(F);if(0===t.length)return;const s=t.map(e=>({id:Date.now()+Math.random(),file:e,name:e.name,size:e.size,status:"pending",progress:0,content:null,analysis:null}));b(e=>[...e,...s]),M(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${t.length} Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­`),t.length>0&&!_&&I(s[0])},I=async e=>{D(!0),N(e);try{P(e.id,"analyzing",10);const t=await(async e=>new Promise((t,s)=>{const n=new FileReader;n.onload=e=>{t(e.target.result)},n.onerror=()=>{s(new Error("ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù"))},n.readAsText(e,"UTF-8")}))(e.file);P(e.id,"analyzing",30),b(s=>s.map(s=>s.id===e.id?{...s,content:t}:s)),M("ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­. Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„..."),P(e.id,"analyzing",50);const s={start:()=>{},progress:t=>{const s=Math.min(90,50+Math.floor((t?.completed||0)/(t?.total||1)*40));P(e.id,"analyzing",s)},complete:()=>{},warn:()=>{}},a=await async function(e,t="ar",s=null){if(null==e||"string"!=typeof e)throw new Error("Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¯Ø®Ù„ ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­");const a=String(e);if(!a.trim())throw new Error("Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¯Ø®Ù„ ÙØ§Ø±Øº");const y=r(e=a);if(y>2e5)throw new Error("Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (200,000 ÙƒÙ„Ù…Ø©)");s?.start?.("text_analysis",{wordCount:y,language:t});const f={content:e.substring(0,1e3),language:t,wordCount:y},w=await J.get("text_analysis",f);if(w)return s?.complete?.("text_analysis",{source:"cache"}),w.data;s?.progress?.("quick_analysis",{stage:"local_nlp"});const b=c(e),v=o(e),j=i(e),_=l(e),D=d(e),C=u(e,D);s?.complete?.("quick_analysis",{localProcessing:!0,chapters:(b.chapters||[]).length,pages:(b.pages||[]).length,duplicateRate:_.overall?.repetitionRate??_.shingles?.rate??0});let N=!1,k=null;if(y>5e4){s?.start?.("chunk_processing",{words:y});const t=new X(1e4),n=t.chunkText(e);s?.progress?.("chunk_processing",{stage:"parallel_processing",chunks:n.length});const a=await t.processParallel(n,async(e,t)=>({chapters:g(e.text),pages:p(e.text),classification:h(e.text),stats:i(e.text)}),{concurrency:3,onProgress:e=>{s?.progress?.("chunk_processing",{...e,stage:"processing_chunks"})}});k=t.mergeResults(a.results,"analysis"),N=!0,s?.complete?.("chunk_processing",{chunks:n.length,successRate:a.summary.successRate})}s?.start?.("text_cleaning",{});let S=e;(b.pages||[]).forEach(e=>{const t=(e.text||e.match||"").replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(t){const e=new RegExp(t,"g");S=S.replace(e,"")}});const B=b.toc;B&&Array.isArray(B)&&B.length>0&&B.forEach(e=>{if(null!=e?.startLine&&null!=e?.endLine){const t=S.split("\n");t.splice(e.startLine,e.endLine-e.startLine+1),S=t.join("\n")}}),(_.overall?.repetitionRate??_.shingles?.rate??0)>20&&(s?.progress?.("text_cleaning",{stage:"removing_duplicates"}),S=m(S,.8));const M=Array.isArray(C)?C:[],E=Array.isArray(D)?D:[];if(M.length>5&&E.length>0&&M.length/E.length>.1){s?.progress?.("text_cleaning",{stage:"removing_irrelevant_llm"});const t=`Ù†Ø¸Ù‘Ù Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ Ù…Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ø°ÙŠ Ø§Ù„ØµÙ„Ø©. ØªÙ… Ø§Ù„ÙƒØ´Ù Ø¹Ù† ${M.length} ÙÙ‚Ø±Ø© ØºÙŠØ± Ø°Ø§Øª ØµÙ„Ø©.\n\nØ§Ø­Ø°Ù ÙÙ‚Ø·:\n- Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©\n- Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù…Ù† Ù…ØµØ§Ø¯Ø± Ø£Ø®Ø±Ù‰\n- Ø§Ù„Ù†ØµÙˆØµ Ù…Ù† ÙƒØªØ¨ Ø£Ø®Ø±Ù‰\n\nØ§Ø­ØªÙØ¸ Ø¨Ù€:\n- ÙƒÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø±Ø¯ÙŠ\n- Ø§Ù„Ø­ÙˆØ§Ø±Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©\n- Ø§Ù„Ø£ÙˆØµØ§Ù\n\nØ§Ù„Ù†Øµ:\n---\n${S.substring(0,8e4)}\n---`,a=await n.invokeLLM({messages:[{role:"user",content:t}],temperature:.3,max_tokens:8e4});S=a.output;const r=te(S,e);r.passed||s?.progress?.("text_cleaning",{warning:"language_issues",issues:r.issues})}const F=r(S),L=F/y*100;L<60&&s?.warn?.("excessive_deletion",{original:y,cleaned:F,preservationRate:L.toFixed(1)}),s?.complete?.("text_cleaning",{cleanedWordCount:F,deletedWords:y-F,preservationRate:L.toFixed(1)+"%"}),s?.start?.("chapter_division",{});const I=x(S,{minChapters:2,maxChapters:13,targetWordsPerChapter:6e3,preserveExisting:!0});let P=I.chapters;if("smart"===I.method&&I.actualChapters<2){s?.progress?.("chapter_division",{stage:"llm_fallback"});const e=`Ù‚Ø³Ù‘Ù… Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ Ø¥Ù„Ù‰ ÙØµÙˆÙ„ (2-13 ÙØµÙ„):\n\nØ§Ù„Ù†Øµ (${F} ÙƒÙ„Ù…Ø©):\n---\n${S.substring(0,1e5)}\n---\n\nØ£Ø¹Ø¯ JSON:\n{\n  "chapters": [\n    {\n      "number": 1,\n      "title": "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØµÙ„",\n      "start_position": 0,\n      "end_position": 500,\n      "summary": "Ù…Ù„Ø®Øµ Ù‚ØµÙŠØ±"\n    }\n  ]\n}`,t=(await n.invokeLLM({messages:[{role:"user",content:e}],temperature:.5,max_tokens:4e3})).output.match(/\{[\s\S]*\}/);P=(t?JSON.parse(t[0]):{chapters:[]}).chapters||[]}s?.complete?.("chapter_division",{method:I.method,chaptersCount:P.length}),s?.start?.("content_compensation",{});const T=5e4-F;let z=S;if(T>5e3&&T<15e3){s?.progress?.("content_compensation",{stage:"llm_generation",deficit:T});const e=`Ø£Ù†Øª ÙƒØ§ØªØ¨ Ù…Ø­ØªØ±Ù. Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${F} ÙƒÙ„Ù…Ø© ÙˆÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ${T} ÙƒÙ„Ù…Ø© Ø¥Ø¶Ø§ÙÙŠØ©.\n\nØ£Ø¶Ù Ù…Ø­ØªÙˆÙ‰ Ø·Ø¨ÙŠØ¹ÙŠØ§Ù‹ ÙŠØªÙ…Ø§Ø´Ù‰ Ù…Ø¹ Ø§Ù„Ù†Øµ Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø§Ù‡Ø¯ Ø¬Ø¯ÙŠØ¯Ø©:\n- ÙˆØ³Ù‘Ø¹ Ø§Ù„Ø£ÙˆØµØ§Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©\n- Ø£Ø¶Ù ØªÙØ§ØµÙŠÙ„ Ù„Ù„Ø´Ø®ØµÙŠØ§Øª\n- Ø·ÙˆÙ‘Ø± Ø§Ù„Ø­ÙˆØ§Ø±Ø§Øª Ù‚Ù„ÙŠÙ„Ø§Ù‹\n\nØ§Ù„Ù†Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ:\n---\n${S.substring(0,5e4)}\n---\n\nØ£Ø¹Ø¯ Ø§Ù„Ù†Øµ ÙƒØ§Ù…Ù„Ø§Ù‹ Ù…Ø¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª.`;z=(await n.invokeLLM({messages:[{role:"user",content:e}],temperature:.8,max_tokens:2e4})).output}const $=r(z);s?.complete?.("content_compensation",{finalWordCount:$});const A={cleaned_text:z,statistics:{original_word_count:y,cleaned_word_count:F,final_word_count:$,words_removed:y-F,words_added:$-F,preservation_rate:(F/y*100).toFixed(1)+"%",...j},structure:{detected_language:v,chapters_found:(b.chapters||[]).length,pages_removed:(b.pages||[]).length,toc_sections_removed:(b.toc||[]).length,headers:(b.structure?.headers||[]).length,processed_in_chunks:N,chunk_results:k},quality:{repetition_rate:(_.overall?.repetitionRate??_.shingles?.rate??0).toFixed(1)+"%",duplicate_paragraphs:_.paragraphs?.duplicates??0,repeated_sentences:_.sentences?.repeated??0,irrelevant_content_count:M.length,main_content_type:ne(D)},chapters:P,classifications:D.slice(0,20),recommendations:ae(y,$,_.overall?.repetitionRate??_.shingles?.rate??0,M.length),metadata:{analysis_method:N?"chunked_local_nlp":"local_nlp",llm_calls:re(M.length,I.method,T),processing_date:(new Date).toISOString(),version:"2.0-enhanced"}};return await J.set("text_analysis",f,A,{persist:!0,dbTTL:864e5}),s?.complete?.("text_analysis",{finalWordCount:$,chaptersCount:P.length,method:A.metadata.analysis_method}),A}(t,"ar",s);await T(a,{...e,content:t})}catch(t){P(e.id,"error",0),E(`ÙØ´Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù: ${t.message}`),D(!1),N(null)}},P=(e,t,s)=>{b(n=>n.map(n=>n.id===e?{...n,status:t,progress:s}:n))},T=async(e,t)=>{const s=t||C;if(s){b(t=>t.map(t=>t.id===s.id?{...t,status:"completed",progress:100,analysis:e}:t)),S(e),M("âœ… ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©.");try{await(async(e,t)=>{try{P(e.id,"analyzing",80);const s=new FormData;s.append("file",e.file),s.append("title",e.name.replace(/\.(txt|docx|pdf)$/i,"")),s.append("content",e.content||""),s.append("word_count",String(t.wordCount||0)),s.append("metadata",JSON.stringify({chapters:t.chapters||[],content_type:t.contentType,language:t.language,analysis:t}));const n="".replace(/\/$/,""),a=n?`${n}/api/shadow7/manuscripts/upload`:"/api/shadow7/manuscripts/upload",r=await fetch(a,{method:"POST",body:s});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.detail||r.statusText||"ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹")}const o=await r.json();return P(e.id,"completed",100),M("ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø®Ø·ÙˆØ·Ø© Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! ğŸ‰"),o}catch(s){throw E(`ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ${s.message}`),s}})(s,e)}catch(n){}}D(!1),N(null)},z=t.useCallback(e=>{e.preventDefault(),e.stopPropagation(),j(!0)},[]),$=t.useCallback(e=>{e.preventDefault(),e.stopPropagation(),j(!1)},[]),A=t.useCallback(e=>{e.preventDefault(),e.stopPropagation()},[]),R=t.useCallback(e=>{e.preventDefault(),e.stopPropagation(),j(!1);const t=e.dataTransfer.files;t.length>0&&L(t)},[]);return e.jsxs("div",{className:"min-h-screen bg-shadow-bg p-6",children:[e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("h1",{className:"text-4xl font-bold text-shadow-text cyber-text",children:"Ø±ÙØ¹ Ù…Ø®Ø·ÙˆØ· Ø¬Ø¯ÙŠØ¯"}),e.jsx("p",{className:"text-shadow-text/60",children:"Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ù†Øµ ÙˆØ³Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ù„ÙŠÙ„Ù‡ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ"})]}),e.jsxs("div",{className:`\n            cyber-card relative rounded-lg border-2 border-dashed p-12 text-center\n            transition-all duration-300 cursor-pointer\n            ${v?"border-shadow-accent bg-shadow-accent/10 scale-105":"border-shadow-primary/30 hover:border-shadow-accent/50"}\n          `,onDragEnter:z,onDragOver:A,onDragLeave:$,onDrop:R,onClick:()=>{B.current?.click()},children:[e.jsx("input",{ref:B,type:"file",multiple:!0,accept:".txt,text/plain",onChange:e=>{e.target.files&&e.target.files.length>0&&L(e.target.files)},className:"hidden"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:`\n                w-24 h-24 rounded-full flex items-center justify-center\n                ${v?"bg-shadow-accent/20":"bg-shadow-primary/10"}\n                transition-all\n              `,children:e.jsx(y,{className:`\n                  w-12 h-12\n                  ${v?"text-shadow-accent animate-pulse":"text-shadow-text/60"}\n                `})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-shadow-text mb-2",children:v?"Ø£ÙÙ„Øª Ø§Ù„Ù…Ù„ÙØ§Øª Ù‡Ù†Ø§":"Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‡Ù†Ø§"}),e.jsx("p",{className:"text-shadow-text/60",children:"Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ"})]}),e.jsxs("div",{className:"flex justify-center gap-2 flex-wrap text-sm text-shadow-text/40",children:[e.jsx("span",{children:"Ø§Ù„ØµÙŠØº Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©:"}),e.jsx("span",{className:"text-shadow-accent",children:"TXT"})]}),e.jsx("div",{className:"text-sm text-shadow-text/40",children:"Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø­Ø¬Ù…: 50 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª"})]})]}),a.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h2",{className:"text-2xl font-bold text-shadow-text",children:["Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© (",a.length,")"]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:a.map(t=>e.jsx(ie,{fileObj:t,onRemove:()=>{return e=t.id,b(t=>t.filter(t=>t.id!==e)),void(C?.id===e&&(N(null),D(!1)));var e},onAnalyze:()=>I(t),isProcessing:C?.id===t.id},t.id))})]}),k&&e.jsxs("div",{className:"cyber-card bg-shadow-surface rounded-lg border border-shadow-primary/20 p-6",children:[e.jsxs("h2",{className:"text-2xl font-bold text-shadow-text mb-4 flex items-center gap-2",children:[e.jsx(f,{className:"w-6 h-6 text-shadow-accent"}),"Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„"]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(ce,{label:"Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª",value:k.wordCount?.toLocaleString()||"0"}),e.jsx(ce,{label:"Ø§Ù„ÙØµÙˆÙ„",value:k.chapters?.length||"0"}),e.jsx(ce,{label:"Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰",value:k.contentType||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}),e.jsx(ce,{label:"Ø§Ù„Ø­Ø§Ù„Ø©",value:"Ø¬Ø§Ù‡Ø² Ù„Ù„Ù†Ø´Ø±",icon:e.jsx(w,{className:"w-5 h-5 text-green-500"})})]})]})]}),e.jsx("div",{className:"fixed inset-0 pointer-events-none opacity-10 cyber-grid -z-10"})]})},ie=({fileObj:t,onRemove:s,onAnalyze:n,isProcessing:a})=>e.jsx("div",{className:"cyber-card bg-shadow-surface rounded-lg border border-shadow-primary/20 p-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex-shrink-0",children:(()=>{switch(t.status){case"completed":return e.jsx(w,{className:"w-5 h-5 text-green-500"});case"error":return e.jsx(j,{className:"w-5 h-5 text-red-500"});case"analyzing":return e.jsx("div",{className:"w-5 h-5 border-2 border-shadow-accent border-t-transparent rounded-full animate-spin"});default:return e.jsx(v,{className:"w-5 h-5 text-shadow-text/60"})}})()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-shadow-text font-semibold truncate",children:t.name}),e.jsxs("div",{className:"flex items-center gap-3 text-sm text-shadow-text/60",children:[e.jsx("span",{children:le(t.size)}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:(()=>{switch(t.status){case"completed":return"Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„";case"error":return"ÙØ´Ù„";case"analyzing":return"Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...";default:return"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"}})()})]})]}),"analyzing"===t.status&&e.jsx("div",{className:"w-32",children:e.jsx("div",{className:"h-2 bg-shadow-bg rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-shadow-accent transition-all duration-300",style:{width:`${t.progress}%`}})})}),e.jsxs("div",{className:"flex gap-2",children:["pending"===t.status&&!a&&e.jsx("button",{onClick:n,className:"cyber-button bg-shadow-accent px-4 py-2 rounded text-sm hover:shadow-glow transition-all",children:"ØªØ­Ù„ÙŠÙ„"}),e.jsx("button",{onClick:s,className:"p-2 rounded hover:bg-red-500/10 text-red-500 transition-colors",disabled:a,children:e.jsx(b,{className:"w-5 h-5"})})]})]})}),ce=({label:t,value:s,icon:n})=>e.jsxs("div",{className:"bg-shadow-bg rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm text-shadow-text/60",children:t}),n]}),e.jsx("div",{className:"text-2xl font-bold text-shadow-text",children:s})]}),le=e=>{if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["Bytes","KB","MB","GB"][t]};export{oe as default};
